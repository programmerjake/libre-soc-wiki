# Build instructions for Microwatt

WIP integrate from <https://libre-soc.org/irclog/%23libre-soc.2022-01-26.log.html>

* install verilator: <https://git.libre-soc.org/?p=dev-env-setup.git;a=blob;f=verilator-install;hb=HEAD>
* install yosys <https://git.libre-soc.org/?p=dev-env-setup.git;a=blob;f=hdl-tools-yosys;hb=HEAD>
* install ghdl-yosys-plugin

After installing ghdl-yosys-plugin use schroot to switch environment

    schroot -c bullseye_ghdl
    git clone https://git.libre-soc.org/git/microwatt.git
    git checkout -b verilator_trace
    export FPGA_TARGET=verilator
    make microwatt-verilator

Then run the resulting binary

    time ./microwatt-verilator

If everything works correcly it will print out an light bulb in ascii art
with the message Microwatt, it works. On my ASUS KGPE D16 this takes

     real	1m4.986s
     user	1m4.373s
     sys	0m0.013s
     
## Building the kernel
On a POWER9 there is no need to install gcc-powerpc64le-linux-gnu, 
you can omit CROSS_COMPILE and ARCH in this case

	apt install gcc-powerpc64le-linux-gnu
	apt install flex bison lz4
	git clone -b microwatt-5.7 https://git.kernel.org/pub/scm/linux/kernel/git/joel/microwatt.git
	cd microwatt
	wget https://ftp.libre-soc.org/microwatt-linux-5.7.patch
	patch -p1 < microwatt-linux-5.7.patch
	wget http://ftp.libre-soc.org/rootfs.cpio
	CROSS_COMPILE="ccache powerpc64le-linux-gnu-" ARCH=powerpc make -j8 O=microwatt microwatt_defconfig
	CROSS_COMPILE="ccache powerpc64le-linux-gnu-" ARCH=powerpc make -j8 O=microwatt
	
This will produce a file 
	microwatt/arch/powerpc/boot/dtbImage.microwatt

## Building sdram_init.bin
This needs gcc-powerpc64le-linux-gnu if cross compilation is used.
	cd microwatt
	cd litedram/gen-src/sdram_init/
	make 
	
## Building microwatt-verilator using the libre-soc core
	cd /path/to/soc
	make microwatt_external_core
	cp external_core_top.v /path/to/microwatt
	cd /path/to/microwatt
	export FPGA_TARGET=verilator
	export GHDLSYNTH=ghdl
	make microwatt-verilator

## Running the simulation
	cp microwatt/arch/powerpc/boot/dtbImage.microwatt
	./microwatt-verilator sdram_init.bin dtbImage.microwatt
